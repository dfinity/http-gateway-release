name: Update

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-packages:
    permissions: write-all
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Update ic-gateway
        run: ./update.sh ic-gateway

      - name: Update ic-http-lb
        run: ./update.sh ic-http-lb

      - name: Fake change
        run: echo 1 > temp.txt

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e
        with:
          delete-branch: true
          title: "Update packages"
          commit-message: "Update packages"

      - name: Enable Pull Request Automerge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}

      - name: Auto approve
        if: steps.cpr.outputs.pull-request-operation == 'created'
        run: gh pr review --approve "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
