# HTTP Gateway SEV-SNP Attestation Guide

This guide walks you through the process of remotely attesting SEV-SNP-enabled HTTP
Gateways operated by DFINITY. It includes fetching an attestation report from a
remote HTTP gateway, verifying its authenticity, and validating the measurement
to ensure the VM is running expected software.

_Note:_ These instructions work **only on Linux** and have been tested with snpguest 0.9.1.

## 1. Get the Attestation Report from the HTTP Gateway

### SEV-SNP-enabled HTTP Gateways

* `tp1-bnp01-vm.ic0.app`
* `tp1-bnp02-vm.ic0.app`
* `tp1-bnp03-vm.ic0.app`

* `fr1-bnp01-vm.ic0.app`
* `fr1-bnp02-vm.ic0.app`
* `fr1-bnp03-vm.ic0.app`

* `zh2-bnp02-vm.ic0.app`
* `zh2-bnp03-vm.ic0.app`
* `zh2-bnp04-vm.ic0.app`

### Fetch the Attestation Report

Choose an HTTP gateway from the list above and set it as the HTTP_GATEWAY environment variable.
Then, fetch the attestation report:

```
export HTTP_GATEWAY=fr1-bnp01-vm.ic0.app

dd if=/dev/zero bs=64 count=1 | \
  curl -svk --data-binary @- "https://${HTTP_GATEWAY}/sev-snp/report" > report.bin
```

## 2. Verify the Attestation Report

### Install `snpguest`

Ensure you have Rust installed, then install the snpguest tool:

```
cargo install snpguest
```

### Fetch AMD Endorsement Keys and Verify

```
# Fetch AMD CA certificates for Milan
snpguest fetch ca --endorser vcek pem . milan

# Fetch the VCEK for the attestation report
snpguest fetch vcek pem . report.bin

# Verify the attestation report
snpguest verify attestation . report.bin
```

Expected successful output:

```
Reported TCB Boot Loader from certificate matches the attestation report.
Reported TCB TEE from certificate matches the attestation report.
Reported TCB SNP from certificate matches the attestation report.
Reported TCB Microcode from certificate matches the attestation report.
VEK signed the Attestation Report!
```

At this point, you have confirmed that the report was generated by a valid
SEV-SNP platform.

## 3. Verify the Measurement

Now confirm that the measurement reported matches the expected measurement for
the workload (kernel, initramfs, OVMF, etc.).

### Download Expected VM Components

Get the latest release from this [repository](https://github.com/dfinity/http-gateway-release/releases/latest) and download the following files:
* `OVMF.fd` (BIOS)
* `vmlinuz` (Linux kernel)
* `initramfs.cpio.gz` (Initramfs)

### Install `sev-snp-measure`

```
pip install sev-snp-measure
```

### Calculate the Expected Measurement

```
sev-snp-measure \
  --mode snp \
  --vcpus 30 \
  --vcpu-family=25 \
  --vcpu-model=1 \
  --vcpu-stepping=1 \
  --ovmf OVMF.fd \
  --kernel vmlinuz \
  --initrd initramfs.cpio.gz \
  --append='console=ttyS0,115200n8'
```

Sample output:
```
df930a01af20a23dcf2cdf50f231f4d9f2738ff30c9db7860f6de7ab64f96f19c4e913abba9f57206c2bb3319ac6682b
```

### Compare Against Reported Measurement

Display the attestation report:
```
snpguest display report report.bin
```

Look for the `Measurement:` section, and compare the hash to the one from `sev-snp-measure`.
```
...
Measurement:
DF 93 0A 01 AF 20 A2 3D CF 2C DF 50 F2 31 F4 D9
F2 73 8F F3 0C 9D B7 86 0F 6D E7 AB 64 F9 6F 19
C4 E9 13 AB BA 9F 57 20 6C 2B B3 31 9A C6 68 2B
...
```

If the values match, you have verified that the remote VM is running the
expected software stack, a full HTTP gateway.
